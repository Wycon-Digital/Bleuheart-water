<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Water Refill Station POS</title>
  <!-- Your existing CSS remains the same -->
  <style>
    /* Your existing CSS here */
  </style>
</head>
<body>
  <!-- Your existing HTML structure remains the same -->
  
  <script>
// Configuration
const GITHUB_CONFIG = {
  username: 'Wycon-Digital',
  repository: 'Bleuheart-water',
  filepath: 'sales_data.json'
};

// Initialize data structures
let cart = [];
let selectedPaymentMethod = '';
let salesData = {
  dailyLogs: {},
  transactions: []
};
let dailySales = {
  totalAmount: 0,
  transactions: 0,
  salesBySize: {
    '20': { quantity: 0, amount: 0 },
    '10': { quantity: 0, amount: 0 },
    '5': { quantity: 0, amount: 0 },
    '1': { quantity: 0, amount: 0 }
  },
  paymentMethods: {
    cash: { count: 0, amount: 0 },
    mpesa: { count: 0, amount: 0 }
  }
};

// GitHub integration functions
async function setupGitHubToken() {
  let token = localStorage.getItem('github_token');
  if (!token) {
    token = prompt('Please enter your GitHub Personal Access Token:');
    if (token) {
      localStorage.setItem('github_token', token);
    }
  }
  return token;
}

async function loadDataFromGitHub() {
  const token = await setupGitHubToken();
  if (!token) return;

  try {
    const response = await fetch(
      `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/contents/${GITHUB_CONFIG.filepath}`,
      {
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3.raw'
        }
      }
    );

    if (response.ok) {
      salesData = await response.json();
      const currentDate = getFormattedDate();
      if (salesData.dailyLogs[currentDate]) {
        dailySales = salesData.dailyLogs[currentDate];
        updateDailySummary();
      }
    }
  } catch (error) {
    console.error('Error loading data:', error);
    // Try loading from local storage as fallback
    const localData = localStorage.getItem('salesData');
    if (localData) {
      try {
        salesData = JSON.parse(localData);
        const currentDate = getFormattedDate();
        if (salesData.dailyLogs[currentDate]) {
          dailySales = salesData.dailyLogs[currentDate];
          updateDailySummary();
        }
      } catch (e) {
        console.error('Error parsing local data:', e);
      }
    }
  }
}

async function saveToGitHub(saleData) {
  const token = await setupGitHubToken();
  if (!token) return;

  try {
    // First, get current file SHA
    const getCurrentFile = await fetch(
      `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/contents/${GITHUB_CONFIG.filepath}`,
      {
        headers: {
          'Authorization': `token ${token}`
        }
      }
    );

    let sha;
    if (getCurrentFile.ok) {
      const fileData = await getCurrentFile.json();
      sha = fileData.sha;
    }

    // Update the file
    const content = btoa(JSON.stringify(salesData, null, 2));
    const response = await fetch(
      `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repository}/contents/${GITHUB_CONFIG.filepath}`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: `Update sales data - ${new Date().toISOString()}`,
          content: content,
          sha: sha
        })
      }
    );

    if (!response.ok) {
      throw new Error('Failed to save to GitHub');
    }

    // Save to local storage as backup
    localStorage.setItem('salesData', JSON.stringify(salesData));

  } catch (error) {
    console.error('Error saving to GitHub:', error);
    localStorage.setItem('salesData', JSON.stringify(salesData));
    alert('Warning: Could not save to GitHub. Data saved locally.');
  }
}

// Utility functions
function getFormattedDate() {
  const now = new Date();
  return now.toISOString().split('T')[0];
}

function updateDateTime() {
  const now = new Date();
  document.getElementById('current-date').textContent = now.toLocaleDateString();
  document.getElementById('current-time').textContent = now.toLocaleTimeString();
}

// UI functions
function selectPaymentMethod(method) {
  selectedPaymentMethod = method;
  document.querySelectorAll('.payment-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  event.target.classList.add('selected');
}

function addToCart(liters, price) {
  const qtyInput = document.getElementById(`qty${liters}`);
  const quantity = parseInt(qtyInput.value);
  if (quantity > 0) {
    cart.push({
      liters: liters,
      price: price,
      quantity: quantity,
      total: price * quantity
    });
    qtyInput.value = "0";
    updateCart();
  }
}

function updateCart() {
  const cartItems = document.getElementById('cart-items');
  const totalElement = document.getElementById('total');
  let cartHTML = '';
  let total = 0;
  cart.forEach((item, index) => {
    cartHTML += `
      <div class="cart-item">
        <span>${item.quantity}x ${item.liters}L Water</span>
        <span>Ksh ${item.total}</span>
        <button onclick="removeItem(${index})" style="color: red; background: none; border: none;">Ã—</button>
      </div>
    `;
    total += item.total;
  });
  cartItems.innerHTML = cartHTML;
  totalElement.innerHTML = `<h3>Total: Ksh ${total}</h3>`;
}

function removeItem(index) {
  cart.splice(index, 1);
  updateCart();
}

function updateDailySummary() {
  document.getElementById('total-sales').textContent = dailySales.totalAmount;
  document.getElementById('total-transactions').textContent = dailySales.transactions;
  
  let salesBySizeHTML = '<h3>Sales by Container Size:</h3>';
  for (let size in dailySales.salesBySize) {
    salesBySizeHTML += `
      <p>${size}L: ${dailySales.salesBySize[size].quantity} units 
         (Ksh ${dailySales.salesBySize[size].amount})</p>
    `;
  }
  document.getElementById('sales-by-size').innerHTML = salesBySizeHTML;
  
  let salesByPaymentHTML = '<h3>Sales by Payment Method:</h3>';
  salesByPaymentHTML += `
    <p>Cash: ${dailySales.paymentMethods.cash.count} transactions 
       (Ksh ${dailySales.paymentMethods.cash.amount})</p>
    <p>M-Pesa: ${dailySales.paymentMethods.mpesa.count} transactions 
       (Ksh ${dailySales.paymentMethods.mpesa.amount})</p>
  `;
  document.getElementById('sales-by-payment').innerHTML = salesByPaymentHTML;
}

async function checkout() {
  if (cart.length === 0) {
    alert('Cart is empty!');
    return;
  }
  if (!selectedPaymentMethod) {
    alert('Please select a payment method (Cash or M-Pesa)');
    return;
  }

  const currentDate = getFormattedDate();
  const total = cart.reduce((sum, item) => sum + item.total, 0);

  // Update daily sales
  dailySales.totalAmount += total;
  dailySales.transactions += 1;
  cart.forEach(item => {
    dailySales.salesBySize[item.liters].quantity += item.quantity;
    dailySales.salesBySize[item.liters].amount += item.total;
  });
  dailySales.paymentMethods[selectedPaymentMethod].count += 1;
  dailySales.paymentMethods[selectedPaymentMethod].amount += total;

  // Update sales data
  if (!salesData.dailyLogs[currentDate]) {
    salesData.dailyLogs[currentDate] = { ...dailySales };
  } else {
    salesData.dailyLogs[currentDate] = dailySales;
  }

  // Add transaction
  const transaction = {
    items: [...cart],
    total: total,
    paymentMethod: selectedPaymentMethod,
    timestamp: new Date().toISOString(),
    date: currentDate
  };
  salesData.transactions.push(transaction);

  // Save to GitHub
  await saveToGitHub(salesData);

  alert(`Sale completed!\nTotal amount: Ksh ${total}\nPayment Method: ${selectedPaymentMethod.toUpperCase()}`);
  
  // Clear cart and update UI
  cart = [];
  selectedPaymentMethod = '';
  document.querySelectorAll('.payment-btn').forEach(btn => btn.classList.remove('selected'));
  updateCart();
  updateDailySummary();
}

function toggleProductList() {
  const productList = document.getElementById('product-list');
  const enterSaleBtn = document.getElementById('enter-sale-btn');
  if (productList.style.display === 'none') {
    productList.style.display = 'flex';
    enterSaleBtn.textContent = 'Hide Products';
  } else {
    productList.style.display = 'none';
    enterSaleBtn.textContent = 'Enter Sale';
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', async function () {
  await loadDataFromGitHub();
  document.getElementById('enter-sale-btn').addEventListener('click', toggleProductList);
  updateDateTime();
  updateDailySummary();
  setInterval(updateDateTime, 1000);
});
  </script>
</body>
</html>
